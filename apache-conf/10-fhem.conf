<Location /fhem>
  RewriteEngine On

  # Debug: Cookie-Header und Map-Auswertung ins Env für Access-Log schreiben
#  RewriteRule ^ - [E=RAWCOOKIE:%{HTTP:Cookie}]
#  RewriteCond ${authcheck:%{HTTP:Cookie}} (.*)
#  RewriteRule ^ - [E=MAPVAL:%1]

  # 1) Standard auf BAD setzen, dann bei OK aus der Map überschreiben
#  RewriteRule ^ - [E=AUTHRES:BAD]
#  RewriteCond ${authcheck:%{HTTP:Cookie}} ^OK
#  RewriteRule ^ - [E=AUTHRES:OK]
  
  # 2) Gate: only on initial request and not for /auth/*
  RewriteCond %{ENV:REDIRECT_STATUS} ^$
  RewriteCond %{REQUEST_URI} !^/auth/
  # Gate anhand der gesetzten Umgebungsvariable
  RewriteCond %{ENV:AUTHRES} !^OK$
  RewriteRule ^ /auth/check.php?return=%{REQUEST_URI} [R=302,L,NE]

  # 3) WebSocket proxy (per-dir; /fhem prefix already stripped)
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteRule ^(.*)$ ws://fhem:8083/fhem$1 [P,L]

  # 4) HTTP proxy
  ProxyPass http://fhem:8083/fhem
  ProxyPassReverse http://fhem:8083/fhem

  Require all granted
</Location>
