<VirtualHost *:443>
    ServerAdmin postmaster@diefaeuste.de
    DocumentRoot /var/www/html

    SSLEngine on
    SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5
    SSLHonorCipherOrder on
    SSLOpenSSLConfCmd DHParameters "/etc/apache2/ssl/dh2048.pem"

    SSLProxyEngine on
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    SSLCertificateFile /etc/letsencrypt/live/tulpemd.diefaeuste.de/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/tulpemd.diefaeuste.de/privkey.pem

    <FilesMatch "\.(?:cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>

    AddType application/x-httpd-php .php
    RewriteMap authcheck "prg:/usr/bin/php /var/www/SimpleWebAuth/validate_auth.php"

    # Map-Auswertung im vHost-Kontext: AUTHRES für alle Pfade außer /auth setzen
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/auth(/|$)
    RewriteCond %{ENV:REDIRECT_STATUS} ^$
    # Baue den Schlüssel für die RewriteMap aus Cookie, REMOTE_ADDR und X-Forwarded-For
    RewriteRule ^ - [E=MAPKEY:%{HTTP:Cookie}|%{REMOTE_ADDR}|%{HTTP:X-Forwarded-For}|%{REQUEST_URI}]
    # Übergib den zusammengesetzten Schlüssel an die Map (stabiler als direkte Verschachtelung)
    RewriteRule ^ - [E=AUTHRES:${authcheck:%{ENV:MAPKEY}}]

</VirtualHost>
